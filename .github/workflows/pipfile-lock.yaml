# The Pipfile.lock we care about is the Linux one.
# The Linux runner environment is closest to the actual robot.
# will only create a PR if there is a diff
# TODO(@y3rsh, 2022-09-12):
# Add in hardware and hardware testing
name: 'Create PR on macos-12 for Pipfile.lock'

on:
  pull_request:
    paths:
    - '.github/workflows/pipfile-lock.yaml'
    - '**setup.py'
    - '**Pipfile.*'
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.ref_name }}
  cancel-in-progress: true

defaults:
  run:
    shell: bash

jobs:
  pipfile-lock:
    name: 'Generate Pipfile.lock on Linux'
    timeout-minutes: 20
    runs-on: 'ubuntu-22.04'
    strategy:
      matrix:
        folder:
          - "shared-data/python"
          - "api"
          - "notify-server"
          - "update-server"
          - "robot-server"
          - "g-code-testing"
          # - "hardware"
          # - "hardware-testing"
    steps:
      - uses: 'actions/checkout@v3'
      - uses: 'actions/setup-node@v3'
        with:
          node-version: '14'
      - uses: 'actions/setup-python@v4'
        with:
          python-version: '3.10'
      - name: 'set complex environment variables'
        uses: actions/github-script@v6.1.1
        with:
          script: |
            const { buildComplexEnvVars, } = require(`${process.env.GITHUB_WORKSPACE}/.github/workflows/utils.js`)
            buildComplexEnvVars(core, context)
      - name: Install pipenv
        run: pip install pipenv==2021.5.29
      - name: Install ${{ matrix.folder }}
        working-directory: ${{ matrix.folder }}
        run: pipenv lock -d -v
      - name: Create Pull Request
        id: cpr
        uses: peter-evans/create-pull-request@v4
        with:
          commit-message: Update Pipfile.lock ${{ matrix.folder }} on branch ${{ github.head_ref || github.ref_name }}
          committer: GitHub <noreply@github.com>
          author: ${{ github.actor }} <${{ github.actor }}@users.noreply.github.com>
          signoff: false
          branch: pipfile-lock-${{ github.head_ref || github.ref_name }}
          base: ${{ github.head_ref || github.ref_name }}
          delete-branch: true
          title: Update Pipfile.lock on branch ${{ github.head_ref || github.ref_name }}
          body: |
            Update the Pipfile.lock on Linux for ${{ matrix.folder }} if needed
            - Auto-generated by [create-pull-request][1]

            [1]: https://github.com/peter-evans/create-pull-request
          draft: false
